// Generated by CoffeeScript 1.6.3
var appContext,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

require.config({
  paths: {
    jquery: "/components/jquery/jquery.min",
    bootstrap: "/components/bootstrap/dist/js/bootstrap.min",
    bootstrapDatepicker: "/components/bootstrap-datepicker/js/bootstrap-datepicker",
    batman: "/batmanjs/batman",
    latestROMS: "/latestROMS.json?callback=define",
    leaflet: "//cdn.leafletjs.com/leaflet-0.7.1/leaflet",
    esriLeaflet: "/esri-leaflet/esri-leaflet"
  },
  shim: {
    bootstrap: {
      deps: ["jquery"]
    },
    bootstrapDatepicker: {
      deps: ["bootstrap"]
    },
    batman: {
      deps: ["jquery"],
      exports: "Batman"
    },
    leaflet: {
      exports: "L"
    },
    esriLeaflet: {
      deps: ["leaflet"]
    }
  },
  waitSeconds: 30
});

appContext = void 0;

define("Batman", ["batman"], function(Batman) {
  return Batman.DOM.readers.batmantarget = Batman.DOM.readers.target && delete Batman.DOM.readers.target && Batman;
});

require(["jquery", "Batman", "latestROMS", "leaflet", "bootstrap", "bootstrapDatepicker", "esriLeaflet"], function($, Batman, latestROMS, L) {
  var AppContext, Rompg, getParameterByName, padTo2Digits, _ref;
  padTo2Digits = function(n) {
    if (n < 10) {
      return "0" + n;
    } else {
      return n;
    }
  };
  getParameterByName = function(name) {
    var regex, results;
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
    results = regex.exec(location.search);
    if (results != null) {
      return decodeURIComponent(results[1].replace(/\+/g, " "));
    } else {
      return "";
    }
  };
  AppContext = (function(_super) {
    __extends(AppContext, _super);

    function AppContext() {
      AppContext.__super__.constructor.apply(this, arguments);
      if (window.location.pathname === "/") {
        this.set("homeContext", new this.HomeContext);
      }
      if (window.location.pathname === "/roms") {
        this.set("romsContext", new this.RomsContext);
      }
      if (window.location.pathname === "/interactive") {
        this.set("interactiveContext", new this.InteractiveContext);
      }
    }

    AppContext.prototype.HomeContext = (function(_super1) {
      __extends(HomeContext, _super1);

      function HomeContext() {
        var now, variable, _i, _len, _ref;
        HomeContext.__super__.constructor.apply(this, arguments);
        _ref = ["curr", "salinity", "ssh", "temp"];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          variable = _ref[_i];
          now = new Date(latestROMS.ca[variable]);
          this.set("latestCaRomsImagePath_" + variable, "/data/ca-roms/" + (now.getUTCFullYear()) + "/ca_" + variable + (padTo2Digits(now.getUTCMonth() + 1)) + (padTo2Digits(now.getUTCDate())) + "_" + (padTo2Digits(now.getUTCHours())) + "_0.jpg");
        }
      }

      return HomeContext;

    })(Batman.Model);

    AppContext.prototype.RomsContext = (function(_super1) {
      var region, varMap, variable, _fn, _fn1, _i, _len, _ref,
        _this = this;

      __extends(RomsContext, _super1);

      varMap = {
        curr: "Current",
        salinity: "Salinity and Current",
        ssh: "Sea Surface Height and Current",
        temp: "Temperature and Current"
      };

      RomsContext.accessor("is03Selected", function() {
        return this.get("now").getUTCHours() === 3;
      });

      RomsContext.accessor("is09Selected", function() {
        return this.get("now").getUTCHours() === 9;
      });

      RomsContext.accessor("is15Selected", function() {
        return this.get("now").getUTCHours() === 15;
      });

      RomsContext.accessor("is21Selected", function() {
        return this.get("now").getUTCHours() === 21;
      });

      RomsContext.accessor("is03Enabled", function() {
        if (this.get("endDate").getUTCHours() >= 3 || new Date(this.get("endDate")).setUTCHours(0, 0, 0, 0) > new Date(this.get("now")).setUTCHours(0, 0, 0, 0)) {
          return "";
        } else {
          return "disabled";
        }
      });

      RomsContext.accessor("is09Enabled", function() {
        if (this.get("endDate").getUTCHours() >= 9 || new Date(this.get("endDate")).setUTCHours(0, 0, 0, 0) > new Date(this.get("now")).setUTCHours(0, 0, 0, 0)) {
          return "";
        } else {
          return "disabled";
        }
      });

      RomsContext.accessor("is15Enabled", function() {
        if (this.get("endDate").getUTCHours() >= 15 || new Date(this.get("endDate")).setUTCHours(0, 0, 0, 0) > new Date(this.get("now")).setUTCHours(0, 0, 0, 0)) {
          return "";
        } else {
          return "disabled";
        }
      });

      RomsContext.accessor("is21Enabled", function() {
        if (this.get("endDate").getUTCHours() >= 21 || new Date(this.get("endDate")).setUTCHours(0, 0, 0, 0) > new Date(this.get("now")).setUTCHours(0, 0, 0, 0)) {
          return "";
        } else {
          return "disabled";
        }
      });

      RomsContext.accessor("imgPath", function() {
        return "/data/ca-roms/" + (this.get("now").getUTCFullYear()) + "/" + (this.get("region")) + "_" + (this.get("variable")) + (padTo2Digits(this.get("now").getUTCMonth() + 1)) + (padTo2Digits(this.get("now").getUTCDate())) + "_" + (padTo2Digits(this.get("now").getUTCHours())) + "_0.jpg";
      });

      RomsContext.accessor("regionLongName", function() {
        return $("ul>li[data-value=\"" + (this.get("region")) + "\"]>a").text();
      });

      _fn = function(region) {
        return RomsContext.accessor("is_" + region, function() {
          return this.get("region") === region;
        });
      };
      for (region in latestROMS) {
        _fn(region);
      }

      _ref = ["curr", "salinity", "ssh", "temp"];
      _fn1 = function(variable) {
        return RomsContext.accessor("is_" + variable, function() {
          return this.get("variable") === variable;
        });
      };
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        variable = _ref[_i];
        _fn1(variable);
      }

      function RomsContext() {
        var now,
          _this = this;
        RomsContext.__super__.constructor.apply(this, arguments);
        if (varMap[getParameterByName("variable")] != null) {
          this.set("variable", getParameterByName("variable"));
        } else {
          this.set("variable", "curr");
        }
        this.set("region", "ca");
        now = new Date(latestROMS[this.get("region")][this.get("variable")]);
        $("[data-provide=\"datepicker-inline\"]").datepicker("setStartDate", "04/24/2013");
        $("[data-provide=\"datepicker-inline\"]").datepicker("setEndDate", "" + (now.getUTCMonth() + 1) + "/" + (now.getUTCDate()) + "/" + (now.getUTCFullYear()));
        this.set("endDate", now);
        this.changeNow(now);
        $("[data-provide=\"datepicker-inline\"]").on("changeDate", function(e) {
          now = new Date(_this.get("now"));
          now.setUTCDate(e.date.getDate());
          now.setUTCMonth(e.date.getMonth());
          now.setUTCFullYear(e.date.getFullYear());
          _this.set("now", now);
          now = new Date(latestROMS[_this.get("region")][_this.get("variable")]);
          if (_this.get("now") > now) {
            return _this.changeNow(now);
          }
        });
        history.replaceState({
          variable: this.get("variable")
        }, null, "/roms?variable=" + (this.get("variable")));
        window.onpopstate = function(e) {
          var _ref1, _ref2;
          return _this.set("variable", (_ref1 = (_ref2 = e.state) != null ? _ref2.variable : void 0) != null ? _ref1 : "curr");
        };
      }

      RomsContext.prototype.timeChanged = function(node) {
        var now;
        now = new Date(this.get("now"));
        now.setUTCHours($(node).attr("data-value"));
        return this.set("now", now);
      };

      RomsContext.prototype.changeNow = function(date) {
        var now;
        this.set("now", date);
        $("[data-provide=\"datepicker-inline\"]").datepicker("update", "" + (date.getUTCMonth() + 1) + "/" + (date.getUTCDate()) + "/" + (date.getUTCFullYear()));
        now = new Date(latestROMS[this.get("region")][this.get("variable")]);
        if (this.get("now") > now) {
          return this.changeNow(now);
        }
      };

      RomsContext.prototype.imageError = function() {
        return this.set("imageError", true);
      };

      RomsContext.prototype.imageLoad = function() {
        return this.set("imageError", false);
      };

      RomsContext.prototype.variableChanged = function(node) {
        var now;
        if (this.get("variable") === $(node).attr("data-value")) {
          return;
        }
        now = new Date(latestROMS[this.get("region")][this.get("variable")]);
        $("[data-provide=\"datepicker-inline\"]").datepicker("setEndDate", "" + (now.getUTCMonth() + 1) + "/" + (now.getUTCDate()) + "/" + (now.getUTCFullYear()));
        this.set("endDate", now);
        this.set("variable", $(node).attr("data-value"));
        this.changeNow(this.get("now") > now ? now : this.get("now"));
        return history.pushState({
          variable: this.get("variable")
        }, null, "/roms?variable=" + (this.get("variable")));
      };

      RomsContext.prototype.regionChanged = function(node) {
        var now;
        if (this.get("region") === $(node).attr("data-value")) {
          return;
        }
        this.set("region", $(node).attr("data-value"));
        now = new Date(latestROMS[this.get("region")][this.get("variable")]);
        $("[data-provide=\"datepicker-inline\"]").datepicker("setEndDate", "" + (now.getUTCMonth() + 1) + "/" + (now.getUTCDate()) + "/" + (now.getUTCFullYear()));
        this.set("endDate", now);
        return this.changeNow(this.get("now") > now ? now : this.get("now"));
      };

      return RomsContext;

    }).call(this, Batman.Model);

    AppContext.prototype.InteractiveContext = (function(_super1) {
      __extends(InteractiveContext, _super1);

      function InteractiveContext() {
        var imap;
        imap = L.map("imap").setView([37.5, -123], 7);
        (new L.esri.BasemapLayer("Oceans")).addTo(imap);
      }

      return InteractiveContext;

    })(Batman.Model);

    return AppContext;

  }).call(this, Batman.Model);
  Rompg = (function(_super) {
    __extends(Rompg, _super);

    function Rompg() {
      _ref = Rompg.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    Rompg.appContext = appContext = new AppContext;

    return Rompg;

  })(Batman.App);
  Rompg.run();
  return $(function() {
    return appContext.set("pageLoaded", true);
  });
});
